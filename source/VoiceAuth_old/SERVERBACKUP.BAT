SET SERVER=JHESERV1
SET BACKUP=FAILED

ECHO STOPPING PROGRAMS
SENDCMD %SERVER%.MANAGEDB SHUTDOWN /TRY=3 /REPLY=OKAY
IF NOT ERRORLEVEL 1 GOTO FAIL

SENDCMD %SERVER%.PREAUTH SHUTDOWN /TRY=3 /REPLY=OKAY
IF NOT ERRORLEVEL 1 GOTO FAIL

SENDCMD %SERVER%.POSFILE SHUTDOWN /TRY=3 /REPLY=OKAY
IF NOT ERRORLEVEL 1 GOTO FAIL

SENDCMD %SERVER%.SPSLOG SHUTDOWN /TRY=3 /REPLY=OKAY
IF NOT ERRORLEVEL 1 GOTO FAIL

SENDCMD %SERVER%.PHONEDB SHUTDOWN /TRY=3 /REPLY=OKAY
IF NOT ERRORLEVEL 1 GOTO FAIL

ECHO COPYING FILES
XCOPY \%SERVER%\SPS\*.* C:\SPS /m/s
IF NOT ERRORLEVEL 1 GOTO FAIL

SET BACKUP=OKAY
GOTO END

:FAIL
:END

ECHO STARTING PROGRAMS
SENDCMD %SERVER%.MANAGEDB HELLO /WAIT=5 /TRY=2 /REPLY="%SERVER%.MANAGEDB ALIVE"
IF ERRORLEVEL 1 GOTO START2
SENDCMD %SERVER%.IPCSHELL "RUN C:\SPS\PROGRAMS\MANAGERDB.EXE" /TRY=3 /REPLY=OKAY

:START2
SENDCMD %SERVER%.PREAUTH HELLO /WAIT=5 /TRY=2 /REPLY="%SERVER%.PREAUTH ALIVE"
IF ERRORLEVEL 1 GOTO START3
SENDCMD %SERVER%.IPCSHELL "RUN C:\SPS\PROGRAMS\PREAUTHDB.EXE" /TRY=3 /REPLY=OKAY

:START3
SENDCMD %SERVER%.POSFILE HELLO /WAIT=5 /TRY=2 /REPLY="%SERVER%.POSFILE ALIVE"
IF ERRORLEVEL 1 GOTO START4 
SENDCMD %SERVER%.IPCSHELL "RUN C:\SPS\PROGRAMS\POSFILDB.EXE" /TRY=3 /REPLY=OKAY

:START4
SENDCMD %SERVER%.SPSLOG HELLO /WAIT=5 /TRY=2 /REPLY="%SERVER%.SPSLOG ALIVE"
IF ERRORLEVEL 1 GOTO START5
SENDCMD %SERVER%.IPCSHELL "RUN C:\SPS\PROGRAMS\SPSLOG.EXE" /TRY=3 /REPLY=OKAY

:START5
SENDCMD %SERVER%.PHONEDB HELLO /WAIT=5 /TRY=2 /REPLY="%SERVER%.PHONEDB ALIVE"
IF ERRORLEVEL 1 GOTO ENDSTART
SENDCMD %SERVER%.IPCSHELL "RUN C:\SPS\PROGRAMS\PHONEDB.EXE" /TRY=3 /REPLY=OKAY
:ENDSTART

IF NOT %BACKUP%==OKAY MSGBOX "BACKUP FAILED" ERROR
IF %BACKUP%==OKAY MSGBOX "BACKUP COMPLETE"


